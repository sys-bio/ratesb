<!DOCTYPE html>
<html lang="en">
<head>
  <noscript>Your browser does not support JavaScript!</noscript>

  <title>RateSB</title>
  <link rel="icon" type="image/png" href="images/logo-transparent-png.png">

  <!-- Style -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link rel="stylesheet" href="css/style.css" />
  <link rel = 'stylesheet' href = "https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl7/1L_dstPt3HV5HzF6Gvk/e3s2lfoUJklFJ1zla2" crossorigin="anonymous">
  
  <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>

  <!-- Importing js files -->
  <script src="sbml/libsbml.js" type="text/javascript"></script>
  <script src="sbml/libsbml.wasm" type="application/wasm"></script>
  <script src="antimony/libantimony.js" type="text/javascript"></script>
  <script src="antimony/libantimony.wasm" type="application/wasm"></script>  
  <script src="sbml/utils.js" type="text/javascript"></script>
  <script src="sbml/processSBML.js" type="text/javascript"></script>
  <script src="sbml/FunctionDefinition.js" type="text/javascript"></script>
  <script src="sbml/Reaction.js" type="text/javascript"></script>
  <script src="sbml/KineticLaw.js" type="text/javascript"></script>
  <script src="sbml/constants.js" type="text/javascript"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

  <script type="text/javascript">
    const lib = libsbml();
    async function loadPyscriptPackages() {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      const micropip = pyodide.pyimport("micropip");
      await micropip.install('sympy');
      // await micropip.install('SBMLKinetics')
      pyodide.runPython(`
        import js
        import sympy
      `);
      return pyodide;
    }

    function setLoading(loading) {
      const loadingIcon = document.getElementById("loading-icon");
      loadingIcon.style.display = loading ? "inline-block" : "none";
    }
    
    var antCode;
    var sbmlCode;
    var sbmlResult = 'None';
    var antResult = 'None';
    var loadAntimonyString; // libantimony function
    var loadString; // "
    var loadSBMLString; // "
    var getSBMLString; // "
    var getAntimonyString; // "
    var getCompSBMLString; // "
    var clearPreviousLoads; // "
    var getLastError; // "
    var getWarnings; // "
    var getSBMLInfoMessages;// "
    var getSBMLWarnings; // "
    var freeAll; // "
    var free; // emscripten function
    var jsAllocateUTF8; // "
    console.log(libantimony);
    // Load library functions (asynchronous call):
    try {
      libantimony().then((libantimony) => {
      // Format: libantimony.cwrap( function name, return type, input param array of types).
      loadString = libantimony.cwrap('loadString', 'number', ['number']);
      loadAntimonyString = libantimony.cwrap('loadAntimonyString', 'number', ['number']);
      loadSBMLString = libantimony.cwrap('loadSBMLString', 'number', ['number']);
      getSBMLString = libantimony.cwrap('getSBMLString', 'string', ['null']);
      getAntimonyString = libantimony.cwrap('getAntimonyString', 'string', ['null']);
      getCompSBMLString = libantimony.cwrap('getCompSBMLString', 'string', ['string']);
      clearPreviousLoads = libantimony.cwrap('clearPreviousLoads', 'null', ['null']);
      getLastError = libantimony.cwrap('getLastError', 'string', ['null']);
      getWarnings = libantimony.cwrap('getWarnings', 'string', ['null']);
      getSBMLInfoMessages = libantimony.cwrap('getSBMLInfoMessages', 'string', ['string']);
      getSBMLWarnings = libantimony.cwrap('getSBMLWarnings', 'string', ['string']);
      freeAll = libantimony.cwrap('freeAll', 'null', ['null']);
      jsFree = (strPtr) => libantimony._free(strPtr);
      jsAllocateUTF8 = (newStr) => libantimony.allocateUTF8(newStr);
      });
    }
    catch (err) {
      console.log('Load libantimony error: ', err);
    }

    // function toggleNightMode() {
    //   const body = document.body;
    //   if (body.classList.contains("night-mode")) {
    //     body.classList.remove("night-mode");
    //   } else {
    //     body.classList.add("night-mode");
    //   }
    // }

    function toggleNightMode() {
      const nightModeToggle = document.getElementById("night-mode-toggle");
      const body = document.body;
      body.classList.toggle("night-mode");
      if (body.classList.contains("night-mode")) {
        nightModeToggle.innerText = "Light Mode";
      } else {
        nightModeToggle.innerText = "Night Mode";
      }
    }

    async function processFileInput() {
      clearPreviousLoads();
      const fileInput = document.querySelector("input[type=file]");
      if (fileInput.files.length === 0) {
        const antStr = document.getElementById("bioModelInput").value;
        if (antStr.length > 0) {
          setLoading(true);
          processTextInput();
          setLoading(false);
          return;
        } else {
          alert("Please select a file.");
          return;
        }
      }
      setLoading(true);
      const pyodide = await loadPyscriptPackages();

      const [file] = fileInput.files;
      const fileReader = new FileReader();

      fileReader.addEventListener(
        "load",
        () => {
          const modelStr = fileReader.result;
          changeSBML(modelStr, pyodide, true);
          setLoading(false);
        },
        false
      );

      if (file) {
        fileReader.readAsText(file);
      }
    }

    async function processTextInput() {
      const modelStr = document.getElementById("bioModelInput").value;
      const pyodide = await loadPyscriptPackages();
      changeSBML(modelStr, pyodide, false);
    }

    /**
     * Converts a model string to SBML format and outputs information about the model. 
     *
     * @param {string} modelStr - The model string to be processed, in Antimony or SBML format.
     * @param {object} pyodide - A Pyodide object used to create the ProcessSBML object.
     */
    function changeSBML(modelStr, pyodide, changeTextInput) {
      // Declare variables
      var sbmlResult;
      var SBMLProcessor;

      // Check if the model string contains the <sbml tag
      if (!modelStr.includes("<sbml")) {
        // If not, load the model string into Antimony
        var ptrAntCode = jsAllocateUTF8(modelStr)
        var loadInt = loadAntimonyString(ptrAntCode);
        console.log("processAntimony: int returned: ", loadInt);

        // If the model loaded successfully, get the SBML string
        if (loadInt > 0) {
          sbmlResult = getSBMLString();
          if (changeTextInput) {
            document.getElementById("bioModelInput").value = modelStr;
          }
        } else {
          const outputBox = document.getElementById("sbml_output");
          outputBox.innerHTML = "";

          const errorMessage = document.createElement("div");
          errorMessage.className = "error-message";
          errorMessage.textContent = "Not valid Antimony!";

          outputBox.appendChild(errorMessage);
          jsFree(ptrAntCode);
          return;
        }
        jsFree(ptrAntCode);

      } else {
        // If the model string already contains the <sbml tag, use it as is
        sbmlResult = modelStr;
        if (changeTextInput) {
          var ptrSBMLCode = jsAllocateUTF8(modelStr);
          var loadInt = loadSBMLString(ptrSBMLCode);
          if (loadInt > 0) {
            document.getElementById("bioModelInput").value = getAntimonyString();
          } else {
            var errStr = getLastError();
            window.alert(errStr);
          }
          jsFree(ptrSBMLCode);
        } 
      }

      // Try to create a new ProcessSBML object with the SBML string
      try {
        var namingConvention = document.getElementById("namingConvention").checked;
        var formattingConvention = document.getElementById("formattingConvention").checked;
        SBMLProcessor = new ProcessSBML(sbmlResult, pyodide, lib, namingConvention, formattingConvention);

        // If successful, get the species, parameters, and reactions from the ProcessSBML object
        const species = SBMLProcessor.getSpeciesList();
        const parameters = SBMLProcessor.getParameterList();
        const reactions = SBMLProcessor.reactions;

        // Create a string to display the results
        var ret = "";
        ret += `species: ${species.toString()}\n`;
        ret += `parameters: ${parameters.toString()}\n`;

        // Loop through the reactions and add them to the string
        for (var i = 0; i < reactions.length; i++) {
          if (reactions[i].id) {
            ret += `${reactions[i].id}: ${reactions[i].toString()}\n`;
          } else {
            ret += `reaction${i}: ${reactions[i].toString()}\n`;
          }
        }

        // Display the string in the HTML element with ID "sbml_output"
        const outputBox = document.getElementById("sbml_output");
        outputBox.innerHTML = "";

        // Split the ret string into lines
        const lines = ret.split("\n");

        // Iterate through the lines and create div elements for each line
        lines.forEach((line) => {
          if (line.trim() === "") return;

          const messageDiv = document.createElement("div");

          if (line.startsWith("Warning")) {
            messageDiv.className = "warning-message";
          } else if (line.startsWith("Error")) {
            messageDiv.className = "error-message";
          }

          messageDiv.textContent = line;
          outputBox.appendChild(messageDiv);
        });

      } catch(err) {
        const outputBox = document.getElementById("sbml_output");
        outputBox.innerHTML = "";

        const errorMessage = document.createElement("div");
        errorMessage.className = "error-message";
        errorMessage.textContent = err.stack;

        outputBox.appendChild(errorMessage);
      }
    }

    async function copyToClipboard() {
      const outputElement = document.getElementById("sbml_output");
      try {
        await navigator.clipboard.writeText(outputElement.innerText);
        // alert("Output copied to clipboard!");
      } catch (err) {
        console.error("Error copying text: ", err);
        alert("Error copying output to clipboard. Please try again.");
      }
    }
  </script>
</head>

<body>
  <div class="container py-5">
    <div class="d-flex justify-content-center align-items-center mb-4">
      <h1 class="mb-0">RateSB</h1>
      <button id="night-mode-toggle" class="night-mode-switch ms-3" onclick="toggleNightMode()">
        Night Mode
      </button>
    </div>
    <p class="text-center">Accepts SBML and Antimony files, or paste Antimony model in the text box.
      <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#infoModal">Info</button>
      <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#errorCodesModal">View Error Codes</button>
    </p>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="infoModalLabel">Website Rules</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>If a file is given, the Antimony version (if the given input is in SBML, it will be converted into Antimony) will be available in the text input box on the left.</p>
            <p>If no file is given, then RateSB will look for the text input and analyze that instead.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="errorCodesModal" tabindex="-1" aria-labelledby="errorCodesModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="errorCodesModalLabel">Error and Warning Codes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Error code explanations -->
            <h5 style="background-color:#ff4d4d;">Error Codes:</h5>
            <p><strong>E001:</strong> No Rate Law entered<br> - The rate law is missing for the given reaction. Please provide a rate law to proceed.</p>
            <p><strong>E002:</strong> Floating reactant<br> - The reaction contains floating reactants, which are not part of any rate law expression. Please ensure all reactants are included in the rate law expression.</p>
        
            <!-- Warning code explanations -->
            <h5 style="background-color:#ffcc00;">Warning Codes:</h5>
            <p><strong>W001:</strong> Rate law contains only number<br> - The rate law consists of only a numeric value. This is usually not a valid rate law for a reaction.</p>
            <p><strong>W002:</strong> Unrecognized rate law from the standard list<br> - The rate law provided does not match any of the recognized standard rate laws. Please verify the rate law and make sure it is in a supported format.</p>
            <p><strong>W003:</strong> Irreversible reaction kinetic law contains products<br> - The rate law for an irreversible reaction should not include products. Please verify the rate law and adjust accordingly.</p>
            <p><strong>W004:</strong> Non-increasing species<br> - The rate law contains species that do not increase during the reaction. This could indicate an issue with the reaction or rate law. Please review the reaction and rate law.</p>
            <h6>Naming Conventions:</h6>
            <p><strong>W005:</strong> We recommend that these parameters start with 'k'<br> - Certain parameters in the rate law are not following the recommended naming convention (starting with 'k'). Consider renaming these parameters to improve readability.</p>
            <p><strong>W006:</strong> We recommend that these parameters start with 'v'<br> - Certain parameters in the rate law are not following the recommended naming convention (starting with 'v'). Consider renaming these parameters to improve readability.</p>
            <h6>Formatting Conventions:</h6>
            <p><strong>W007:</strong> Elements of the same type should be ordered alphabetically<br> - The elements within the rate law are not ordered alphabetically. Reordering the elements can improve readability and consistency.</p>
            <p><strong>W008:</strong> Formatting convention not followed (compartment before parameters before species)<br> - The rate law does not follow the recommended formatting convention, which suggests placing compartments before parameters and species. Adjust the rate law to adhere to this convention for better readability and consistency.</p>
            <p><strong>W009:</strong> Denominator not in alphabetical order<br> - The denominator in the rate law is not ordered alphabetically. Reordering the elements can improve readability and consistency.</p>
            <p><strong>W010:</strong> Numerator and denominator not in alphabetical order<br> - Both the numerator and denominator in the rate law are not ordered alphabetically. Reordering the elements can improve readability and consistency.</p>
            <p><strong>W011:</strong> Numerator convention not followed and denominator not in alphabetical order<br> - The numerator in the rate law does not follow the recommended formatting convention and the denominator is not ordered alphabetically. Adjust the rate law to adhere to these conventions for better readability and consistency.</p>
            <p><strong>W012:</strong> Denominator convention not followed<br> - The denominator in the rate law does not follow the recommended formatting convention. Adjust the rate law to adhere to this convention for better readability and consistency.</p>
            <p><strong>W013:</strong> Numerator not in alphabetical order and denominator convention not followed<br> - The numerator in the rate law is not ordered alphabetically and the denominator does not follow the recommended formatting convention. Adjust the rate law to adhere to these conventions for better readability and consistency.</p>
            <p><strong>W014:</strong> Numerator and denominator convention not followed<br> - Both the numerator and denominator in the rate law do not follow the recommended formatting convention. Adjust the rate law to adhere to this convention for better readability and consistency.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="mb-3">
          <label for="sbml_file" class="form-label">Select a file (.xml, .ant, .txt):</label>
          <input type="file" accept=".xml,.ant,.txt" id="sbml_file" name="SBML file" class="form-control">
        </div>

        <div class="mb-3">
          <textarea id="bioModelInput" class="form-control" rows="20" placeholder="[Antimony code here.]"></textarea>
        </div>

        <div class="mb-3">
          <button id="ClickMe" class="btn btn-primary" onclick="processFileInput()">Analyze Model</button>
        </div>

        <div class="mb-3">
          <input type="checkbox" id="namingConvention" name="namingConvention">
          <label for="namingConvention">Naming Convention Check</label>
        </div>

        <div class="mb-3">
          <input type="checkbox" id="formattingConvention" name="formattingConvention">
          <label for="formattingConvention">Formatting Convention Check</label>
        </div>
      </div>
      <div class="col-md-6">
        <h5>Rate Law Analysis:</h5>
        <div class="spinner-border text-primary" role="status" id="loading-icon" style="display: none;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="output-container">
          <div id="sbml_output" class="output-box"></div>
        </div>
        <button id="copyToClipboard" class="btn btn-secondary mt-3" onclick="copyToClipboard()">Copy to Clipboard</button>
      </div>
    </div>
  </div>
</body>
</html>