<!DOCTYPE html>
<html lang="en">
<head>
  <noscript>Your browser does not support JavaScript!</noscript>

  <title>Local RateSB</title>

  <!-- Style -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link rel="stylesheet" href="css/style.css" />
  <link rel = 'stylesheet' href = "https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
  
  <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>

  <!-- Importing js files -->
  <script src="sbml/libsbml.js" type="text/javascript"></script>
  <script src="sbml/libsbml.wasm" type="application/wasm"></script>
  <script src="antimony/libantimony.js" type="text/javascript"></script>
  <script src="antimony/libantimony.wasm" type="application/wasm"></script>  
  <script src="sbml/utils.js" type="text/javascript"></script>
  <script src="sbml/processSBML.js" type="text/javascript"></script>
  <script src="sbml/FunctionDefinition.js" type="text/javascript"></script>
  <script src="sbml/Reaction.js" type="text/javascript"></script>
  <script src="sbml/KineticLaw.js" type="text/javascript"></script>
  <script src="sbml/constants.js" type="text/javascript"></script>

  <script type="text/javascript">
    const lib = libsbml();
    async function loadPyscriptPackages() {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      const micropip = pyodide.pyimport("micropip");
      await micropip.install('sympy');
      // await micropip.install('SBMLKinetics')
      pyodide.runPython(`
        import js
        import sympy
      `);
      return pyodide;
    }

    function setLoading(loading) {
      const loadingIcon = document.getElementById("loading-icon");
      loadingIcon.style.display = loading ? "inline-block" : "none";
    }
    
    var loadAntimonyString;
    var getSBMLString;

    try {
      libantimony().then((libantimony) => {
      loadAntimonyString = libantimony.cwrap('loadAntimonyString', 'number', ['string']);
      getSBMLString = libantimony.cwrap('getSBMLString', 'string', ['null']);
      });
    }
    catch(err) {
      console.log('Load libantimony error: ', err);
    }

    // function toggleNightMode() {
    //   const body = document.body;
    //   if (body.classList.contains("night-mode")) {
    //     body.classList.remove("night-mode");
    //   } else {
    //     body.classList.add("night-mode");
    //   }
    // }

    function toggleNightMode() {
      const nightModeToggle = document.getElementById("night-mode-toggle");
      const body = document.body;
      body.classList.toggle("night-mode");
      if (body.classList.contains("night-mode")) {
        nightModeToggle.innerText = "Light Mode";
      } else {
        nightModeToggle.innerText = "Night Mode";
      }
    }

    async function processFileInput() {
      const fileInput = document.querySelector("input[type=file]");
      if (fileInput.files.length === 0) {
        alert("Please select a file.");
        return;
      }
      setLoading(true);
      const pyodide = await loadPyscriptPackages();

      const [file] = fileInput.files;
      const fileReader = new FileReader();

      fileReader.addEventListener(
        "load",
        () => {
          const modelStr = fileReader.result;
          changeSBML(modelStr, pyodide);
          setLoading(false);
        },
        false
      );

      if (file) {
        fileReader.readAsText(file);
      }
    }

    /**
     * Converts a model string to SBML format and outputs information about the model. 
     *
     * @param {string} modelStr - The model string to be processed, in Antimony or SBML format.
     * @param {object} pyodide - A Pyodide object used to create the ProcessSBML object.
     */
    function changeSBML(modelStr, pyodide) {

      // Declare variables
      var sbmlResult;
      var SBMLProcessor;

      // Check if the model string contains the <sbml tag
      if (!modelStr.includes("<sbml")) {

        // If not, load the model string into Antimony
        var loadInt = loadAntimonyString(modelStr);
        console.log("processAntimony: int returned: ", loadInt);

        // If the model loaded successfully, get the SBML string
        if (loadInt > 0) {
          sbmlResult = getSBMLString();
        } else {
          const outputBox = document.getElementById("sbml_output");
          outputBox.innerHTML = "";

          const errorMessage = document.createElement("div");
          errorMessage.className = "error-message";
          errorMessage.textContent = "Not valid Antimony!";

          outputBox.appendChild(errorMessage);
          return;
        }

      } else {
        // If the model string already contains the <sbml tag, use it as is
        sbmlResult = modelStr;
      }

      // Output to console to check lib and libantimony()
      console.log(lib);
      console.log(libantimony());

      // Try to create a new ProcessSBML object with the SBML string
      try {
        var namingConvention = document.getElementById("namingConvention").checked;
        SBMLProcessor = new ProcessSBML(sbmlResult, pyodide, lib, namingConvention);
        console.log(SBMLProcessor);

        // If successful, get the species, parameters, and reactions from the ProcessSBML object
        const species = SBMLProcessor.getSpeciesList();
        const parameters = SBMLProcessor.getParameterList();
        const reactions = SBMLProcessor.reactions;

        // Create a string to display the results
        var ret = "";
        ret += `species: ${species.toString()}\n`;
        ret += `parameters: ${parameters.toString()}\n`;

        // Loop through the reactions and add them to the string
        for (var i = 0; i < reactions.length; i++) {
          if (reactions[i].id) {
            ret += `${reactions[i].id}: ${reactions[i].toString()}\n`;
          } else {
            ret += `reaction${i}: ${reactions[i].toString()}\n`;
          }
        }

        // Display the string in the HTML element with ID "sbml_output"
        const outputBox = document.getElementById("sbml_output");
        outputBox.innerHTML = "";

        // Split the ret string into lines
        const lines = ret.split("\n");

        // Iterate through the lines and create div elements for each line
        lines.forEach((line) => {
          if (line.trim() === "") return;

          const messageDiv = document.createElement("div");

          if (line.startsWith("Warning")) {
            messageDiv.className = "warning-message";
          } else if (line.startsWith("Error")) {
            messageDiv.className = "error-message";
          }

          messageDiv.textContent = line;
          outputBox.appendChild(messageDiv);
        });

      } catch(err) {
        const outputBox = document.getElementById("sbml_output");
        outputBox.innerHTML = "";

        const errorMessage = document.createElement("div");
        errorMessage.className = "error-message";
        errorMessage.textContent = err.stack;

        outputBox.appendChild(errorMessage);
      }
    }
  </script>
</head>

<body>
  <div class="container py-5">
    <div class="d-flex justify-content-center align-items-center mb-4">
      <h1 class="mb-0">Local RateSB</h1>
      <button id="night-mode-toggle" class="night-mode-switch ms-3" onclick="toggleNightMode()">
        Night Mode
      </button>
    </div>

    <div class="mb-3">
      <label for="sbml_file" class="form-label">Select an SBML file:</label>
      <input type="file" accept=".xml,.ant,.txt" id="sbml_file" name="SBML file" class="form-control">
    </div>

    <div class="mb-3">
      <button id="ClickMe" class="btn btn-primary" onclick="processFileInput()">Generate SBML</button>
    </div>

    <div class="mb-3">
      <input type="checkbox" id="namingConvention" name="namingConvention">
      <label for="namingConvention">Naming Convention Check</label>
    </div>

    <h5>Rate Law Analysis:</h5>
    <div class="spinner-border text-primary" role="status" id="loading-icon" style="display: none;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="output-container">
      <div id="sbml_output" class="output-box"></div>
    </div>
  </div>
</body>
</html>