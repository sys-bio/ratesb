<head>
  <title>SBRate</title>

  <!-- Style -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link rel="stylesheet" href="css/style.css" />
  <link rel = 'stylesheet' href = "https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">

  <!-- Importing js files -->
  <script src="sbml/libsbml.js" type="text/javascript"></script>
  <script src="sbml/libsbml.wasm" type="application/wasm"></script>
  <script src="sbml/readSBMLmodel.js" type="text/javascript"></script>
  <script src="sbml/writeSBMLmodel.js" type="text/javascript"></script>

  <script type="text/javascript">
    const lib = libsbml();
    function copytoclipboard() {
      var copyText = document.getElementById("sbml_output");

      // Select the text field
      copyText.select();
      copyText.setSelectionRange(0, 99999); // For mobile devices
      // Copy the text inside the text field
      navigator.clipboard.writeText(copyText.value);
    }

    function getSBML(read_from_file) {
      var model_str;
      if (read_from_file) {
        const [file] = document.querySelector("input[type=file]").files;
        const file_reader = new FileReader();

        file_reader.addEventListener(
          "load",
          () => {
            // this will then display a text file
            model_str = file_reader.result;
            change_SBML(model_str, read_from_file);
          },
          false
        );

        if (file) {
          file_reader.readAsText(file);
        }
      } else {
        model_str = document.getElementById("model_input").value;
        change_SBML(model_str, read_from_file);
      }
    }

    function change_SBML(model_str, read_from_file) {
      if (model_str.includes("<sbml") || read_from_file) {
        // now it is safe to use the module
        console.log(lib);
        var sbmlTextBox = document.getElementById("sbml_output");
        const reader = new lib.SBMLReader();
        const sbml_doc = reader.readSBMLFromString(model_str);
        const model = sbml_doc.getModel();
        const species = new Array(model.getNumSpecies());
        for (var i = 0; i < model.getNumSpecies(); i++) {
          species[i] = model.getSpecies(i).getId();
        }
        const parameters = new Array(model.getNumParameters());
        for (i = 0; i < model.getNumParameters(); i++) {
          parameters[i] = model.getParameter(i).getId();
        }
        var ret = "";
        ret += "species: " + species.toString() + "\n";
        ret += "parameters: " + parameters.toString() + "\n";
        sbmlTextBox.value = ret;
      }
    }
  </script>
</head>

<body>
  <label for="sbml_file">Select an SBML file: </label>
  <input type="file" accept=".xml,.ant,.txt" id="sbml_file" name="SBML file" onchange="getSBML(true)">

  <div class="form-group purple-border">
    <h5>Type your model here:</h5>
    <textarea class="form-control" id="model_input" rows="8">
      
    </textarea>
  </div>

  <button id="ClickMe" class = "btn btn-primary" onclick="getSBML(false)">Generate SBML</button>

  <button class = "btn btn-primary" id="CopyToClipboard" onclick="copytoclipboard()">Copy to Clipboard</button>

  <h5>The SBML is:</h5>
  <div class="form-group purple-border">
    <textarea class="form-control" id="sbml_output" style="font-size: 12px!important;" rows="20" height:250px !important;>
    </textarea>
  </div>

</body>