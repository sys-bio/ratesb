<head>
  <noscript>Your browser does not support JavaScript!</noscript>

  <title>Local RateSB</title>

  <!-- Style -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link rel="stylesheet" href="css/style.css" />
  <link rel = 'stylesheet' href = "https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
  
  <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>

  <!-- Importing js files -->
  <script src="sbml/libsbml.js" type="text/javascript"></script>
  <script src="sbml/libsbml.wasm" type="application/wasm"></script>
  <script src="antimony/libantimony.js" type="text/javascript"></script>
  <script src="antimony/libantimony.wasm" type="application/wasm"></script>  
  <script src="sbml/utils.js" type="text/javascript"></script>
  <script src="sbml/processSBML.js" type="text/javascript"></script>
  <script src="sbml/FunctionDefinition.js" type="text/javascript"></script>
  <script src="sbml/Reaction.js" type="text/javascript"></script>
  <script src="sbml/KineticLaw.js" type="text/javascript"></script>
  <script src="sbml/constants.js" type="text/javascript"></script>

  <script type="text/javascript">
    const lib = libsbml();
    async function loadPyscriptPackages() {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      const micropip = pyodide.pyimport("micropip");
      await micropip.install('sympy');
      // await micropip.install('SBMLKinetics')
      pyodide.runPython(`
        import js
        import sympy
      `);
      return pyodide;
    }
    
    var loadAntimonyString;
    var getSBMLString;

    try {
      libantimony().then((libantimony) => {
      loadAntimonyString = libantimony.cwrap('loadAntimonyString', 'number', ['string']);
      getSBMLString = libantimony.cwrap('getSBMLString', 'string', ['null']);
      });
    }
    catch(err) {
      console.log('Load libantimony error: ', err);
    }


    function copytoclipboard() {
      var copyText = document.getElementById("sbml_output");

      // Select the text field
      copyText.select();
      copyText.setSelectionRange(0, 99999); // For mobile devices
      // Copy the text inside the text field
      navigator.clipboard.writeText(copyText.value);
    }

    // read from file input, support reading from '.xml', '.ant', '.txt'
    async function readSBMLFile() {
      const pyodide = await loadPyscriptPackages();
      const [file] = document.querySelector("input[type=file]").files;
      const fileReader = new FileReader();

      fileReader.addEventListener(
        "load",
        () => {
        // this will then display a text file
        const modelStr = fileReader.result;
        changeSBML(modelStr, pyodide);
        },
        false
      );

      if (file) {
        fileReader.readAsText(file);
      }
    }

    // read from text input box
    async function readSBMLtext() {
      const pyodide = await loadPyscriptPackages();
      modelStr = document.getElementById("model_input").value;
      changeSBML(modelStr, pyodide);
    }

    /**
     * Converts a model string to SBML format and outputs information about the model. 
     *
     * @param {string} modelStr - The model string to be processed, in Antimony or SBML format.
     * @param {object} pyodide - A Pyodide object used to create the ProcessSBML object.
     */
    function changeSBML(modelStr, pyodide) {

      // Declare variables
      var sbmlResult;
      var SBMLProcessor;

      // Check if the model string contains the <sbml tag
      if (!modelStr.includes("<sbml")) {

        // If not, load the model string into Antimony
        var loadInt = loadAntimonyString(modelStr);
        console.log("processAntimony: int returned: ", loadInt);

        // If the model loaded successfully, get the SBML string
        if (loadInt > 0) {
          sbmlResult = getSBMLString();
        } else {
          document.getElementById("sbml_output").value = "Not valid Antimony!";
          return;
        }

      } else {
        // If the model string already contains the <sbml tag, use it as is
        sbmlResult = modelStr;
      }

      // Output to console to check lib and libantimony()
      console.log(lib);
      console.log(libantimony());

      // Try to create a new ProcessSBML object with the SBML string
      try {
        SBMLProcessor = new ProcessSBML(sbmlResult, pyodide, lib);
        console.log(SBMLProcessor);

        // If successful, get the species, parameters, and reactions from the ProcessSBML object
        const species = SBMLProcessor.getSpeciesList();
        const parameters = SBMLProcessor.getParameterList();
        const reactions = SBMLProcessor.reactions;

        // Create a string to display the results
        var ret = "";
        ret += `species: ${species.toString()}\n`;
        ret += `parameters: ${parameters.toString()}\n`;

        // Loop through the reactions and add them to the string
        for (var i = 0; i < reactions.length; i++) {
          if (reactions[i].id) {
            ret += `${reactions[i].id}: ${reactions[i].toString()}\n`;
          } else {
            ret += `reaction${i}: ${reactions[i].toString()}\n`;
          }
        }

        // Display the string in the HTML element with ID "sbml_output"
        document.getElementById("sbml_output").value = ret;

      } catch(err) {
        // If an error occurs, display the error stack trace in the HTML element with ID "sbml_output"
        document.getElementById("sbml_output").value = err.stack;
      }
    }
  </script>
</head>

<body>
  <py-config>
  packages = [
    "sympy",
  ]
  </py-config>
  <label for="sbml_file">Select an SBML file: </label>
  <input type="file" accept=".xml,.ant,.txt" id="sbml_file" name="SBML file" onchange="readSBMLFile()">

  <div class="form-group purple-border">
    <h5>Type your model here:</h5>
    <textarea class="form-control" id="model_input" rows="8"></textarea>
  </div>

  <button id="ClickMe" class = "btn btn-primary" onclick="readSBMLtext()">Generate SBML</button>

  <button class = "btn btn-primary" id="CopyToClipboard" onclick="copytoclipboard()">Copy to Clipboard</button>

  <h5>The SBML is:</h5>
  <div class="form-group purple-border">
    <textarea class="form-control" id="sbml_output" style="font-size: 12px!important;" rows="20" height:250px !important;>
    </textarea>
  </div>

</body>