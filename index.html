<!DOCTYPE html>
<html lang="en">
<head>
  <noscript>Your browser does not support JavaScript!</noscript>

  <title>RateSB</title>
  <link rel="icon" type="image/png" href="images/logo-transparent-png.png">

  <!-- Style -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link rel="stylesheet" href="css/style.css" />
  <link rel = 'stylesheet' href = "https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl7/1L_dstPt3HV5HzF6Gvk/e3s2lfoUJklFJ1zla2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js" integrity="sha384-5n0eY3kH6cg3xgF5Z6AAoM6x0jzA6n9+3GdH/7u6g9FJs4Ck5BdPtF+to8xM6B5z" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.4.0/math.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>

  <!-- Importing js files -->
  <script src="sbml/libsbml.js" type="text/javascript"></script>
  <script src="sbml/libsbml.wasm" type="application/wasm"></script>
  <script src="antimony/libantimony.js" type="text/javascript"></script>
  <script src="antimony/libantimony.wasm" type="application/wasm"></script>  
  <script src="sbml/utils.js" type="text/javascript"></script>
  <script src="sbml/processSBML.js" type="text/javascript"></script>
  <script src="sbml/FunctionDefinition.js" type="text/javascript"></script>
  <script src="sbml/Reaction.js" type="text/javascript"></script>
  <script src="sbml/KineticLaw.js" type="text/javascript"></script>
  <script src="sbml/constants.js" type="text/javascript"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

  <script type="text/javascript">
    const lib = libsbml();

  let pyodide = null; // Declare pyodide globally
  window.onload = async function() {
    const loadingOverlay = document.getElementById("loadingOverlay");
    const loadingStatus = document.getElementById("loadingStatus");
    loadingOverlay.style.display = "block";

    const bioModelInput = document.getElementById('bioModelInput');
    bioModelInput.addEventListener('dblclick', searchAndHighlight);
    bioModelInput.tabIndex = 0; // make div focusable
    bioModelInput.addEventListener('keydown', goToNextResult);


    const sbml_output = document.getElementById('sbml_output');
    sbml_output.addEventListener('dblclick', searchAndHighlightReverse);
    sbml_output.tabIndex = 0; // make div focusable
    sbml_output.addEventListener('keydown', goToNextResult);

    const loadPyscriptPackages = async () => {
        loadingStatus.textContent = "Loading Pyodide...";
        const pyodide = await loadPyodide();
        loadingStatus.textContent = "Pyodide loaded! Loading packages...";

        await pyodide.loadPackage("micropip");
        loadingStatus.textContent = "micropip package loaded! Installing sympy...";

        const micropip = pyodide.pyimport("micropip");
        await micropip.install('sympy');
        loadingStatus.textContent = "sympy installed! Installing numpy...";
        await micropip.install('numpy');
        loadingStatus.textContent = "numpy installed! Running Python code...";

        // await micropip.install('SBMLKinetics')
        pyodide.runPython(`
          import js
          import sympy
          import numpy
          from itertools import chain, combinations
        `);
        loadingStatus.textContent = "Python code run successfully! All packages loaded";
        return pyodide;
      };
      pyodide = await loadPyscriptPackages(); // Assign the loaded Pyodide instance to the global variable
      loadingOverlay.style.display = "none";
    };

    function downloadJson() {
      var rateLawsData = [
          {
              "name": "Unidirectional Mass Action",
              "expression": "compartment * parameter * reactant1",
              "optional_symbols": ["compartment", "parameter"],
              "power_limited_species": ["reactant1"]
          },
          {
              "name": "Michaelis-Menten",
              "expression": "compartment * parameter * reactant1 / (reactant1 + parameter)",
              "optional_symbols": ["compartment"],
              "power_limited_species": ["reactant1"]
          },
          {
              "ignore": true,
              "name": "Your own rate law",
              "expression": "use: compartment, parameter, reactant1, reactant2, reactant3, product1, product2, product3, enzyme. Do NOT use: species",
              "optional_symbols": ["symbols that do not have to include in a rate law"],
              "power_limited_species": ["symbols that have to be set to a certain power in a rate law (please specify power in the expression)"]
          }
      ];
      var blob = new Blob([JSON.stringify(rateLawsData)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);

      var a = document.createElement('a');
      a.href = url;
      a.download = 'rate_laws.json';
      a.style.display = 'none';

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    let searchWord = '';
    let currentHighlightIndex = -1;
    let highlights = [];

    function searchAndHighlight() {
      const bioModelInput = document.getElementById('bioModelInput');
      const sbml_output = document.getElementById('sbml_output');

      // Get the selected text
      searchWord = window.getSelection().toString();
      var pattern = /^[A-Za-z_]/;
      // Remove previous highlights
      sbml_output.innerHTML = sbml_output.innerHTML.replace(/<mark class="highlight">|<\/mark>/g, '');
      if (pattern.test(searchWord)) {
        // Highlight all matches
        const regex = new RegExp('\\b' + searchWord + '\\b', 'g');
        sbml_output.innerHTML = sbml_output.innerHTML.replace(regex, '<mark class="highlight">' + searchWord + '</mark>');

        // Get all highlight elements
        highlights = sbml_output.getElementsByClassName('highlight');
        sbml_output.getElementsByClassName('highlight')[0].scrollIntoView({behavior: "smooth", block: "center"});
      } else {

      }
    }

    function searchAndHighlightReverse() {
      const bioModelInput = document.getElementById('bioModelInput');

      let text = bioModelInput.innerHTML;

      // Remove previous highlights
      let regEx = /<span class="highlight">(.*?)<\/span>/gi;
      text = text.replace(regEx, "$1");

      bioModelInput.innerHTML = text;

      text = bioModelInput.innerText;

      // Get the selected text
      var searchWord = window.getSelection().toString();
      var pattern = /^[A-Za-z_]/;

      // Apply new highlights
      if (pattern.test(searchWord)) {
        const highlightedText = text.replace(
          new RegExp('\\b' + searchWord + '\\b', 'gi'),
          '<span class="highlight">$&</span>'
        );
        bioModelInput.innerHTML = highlightedText;

        // Get all highlight elements
        var highlights = bioModelInput.getElementsByClassName('highlight');
        if (highlights.length > 0) {
          highlights[0].scrollIntoView({behavior: "smooth", block: "center"});
        }
      }
    }

    function goToNextResult(event) {
      if (event.key === 'Tab') {
        event.preventDefault();  // Prevent the default action (scrolling)

        // Go to the next highlight
        if (highlights.length > 0) {
          currentHighlightIndex = (currentHighlightIndex + 1) % highlights.length;

          // Scroll the highlight into view
          highlights[currentHighlightIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }
  
    function setLoading(loading) {
      const loadingIcon = document.getElementById("loading-icon");
      loadingIcon.style.display = loading ? "inline-block" : "none";
    }
    
    var antCode;
    var sbmlCode;
    var sbmlResult = 'None';
    var antResult = 'None';
    var loadAntimonyString; // libantimony function
    var loadString; // "
    var loadSBMLString; // "
    var getSBMLString; // "
    var getAntimonyString; // "
    var getCompSBMLString; // "
    var clearPreviousLoads; // "
    var getLastError; // "
    var getWarnings; // "
    var getSBMLInfoMessages;// "
    var getSBMLWarnings; // "
    var freeAll; // "
    var free; // emscripten function
    var jsAllocateUTF8; // "
    console.log(libantimony);
    // Load library functions (asynchronous call):
    try {
      libantimony().then((libantimony) => {
      // Format: libantimony.cwrap( function name, return type, input param array of types).
      loadString = libantimony.cwrap('loadString', 'number', ['number']);
      loadAntimonyString = libantimony.cwrap('loadAntimonyString', 'number', ['number']);
      loadSBMLString = libantimony.cwrap('loadSBMLString', 'number', ['number']);
      getSBMLString = libantimony.cwrap('getSBMLString', 'string', ['null']);
      getAntimonyString = libantimony.cwrap('getAntimonyString', 'string', ['null']);
      getCompSBMLString = libantimony.cwrap('getCompSBMLString', 'string', ['string']);
      clearPreviousLoads = libantimony.cwrap('clearPreviousLoads', 'null', ['null']);
      getLastError = libantimony.cwrap('getLastError', 'string', ['null']);
      getWarnings = libantimony.cwrap('getWarnings', 'string', ['null']);
      getSBMLInfoMessages = libantimony.cwrap('getSBMLInfoMessages', 'string', ['string']);
      getSBMLWarnings = libantimony.cwrap('getSBMLWarnings', 'string', ['string']);
      freeAll = libantimony.cwrap('freeAll', 'null', ['null']);
      jsFree = (strPtr) => libantimony._free(strPtr);
      jsAllocateUTF8 = (newStr) => libantimony.allocateUTF8(newStr);
      });
    }
    catch (err) {
      console.log('Load libantimony error: ', err);
    }

    function handleDragOver(event) {
      event.preventDefault();
    }

    function handleFileDrop(event) {
      event.preventDefault();
      document.getElementById('sbml_file').files = event.dataTransfer.files;
      loadFile();
    }

    let jsonData = [];  // This will store your JSON data

    function handleJsonDragOver(event) {
      event.preventDefault();
  }

  function handleJsonFileDrop(event) {
    event.preventDefault();
    document.getElementById('json_file').files = event.dataTransfer.files;
    loadJsonFile();
  }

  // This function prevents the default behavior when a file is dragged over the drop zone.
  function loadJsonFile() {
    var input = document.getElementById('json_file');
    if(input.files.length > 0) {
        var fileName = input.files[0].name;
        document.getElementById('json_file').innerText = 'File chosen: ' + fileName;
    } else {
        document.getElementById('json_file').innerText = 'Drop or choose custom classification file (.json)';
    }
    const file = input.files[0];

    const jsonFileReader = new FileReader();


    jsonFileReader.addEventListener(
      "load",
      () => {
        console.log("load")
        try {
          jsonData = JSON.parse(jsonFileReader.result);
          console.log(jsonData)
          let warnings = [];
          jsonData = jsonData.filter((item, index) => {
            if (typeof item !== 'object' ||
              !item.hasOwnProperty('name') || typeof item.name !== 'string' ||
              !item.hasOwnProperty('expression') || typeof item.expression !== 'string' ||
              !item.hasOwnProperty('optional_symbols') || !Array.isArray(item.optional_symbols) ||
              !item.hasOwnProperty('power_limited_species') || !Array.isArray(item.power_limited_species)) {
                if (item.hasOwnProperty('name') && typeof(item.name) === 'string') {
                  warnings.push(`Rate law ${item.name} does not follow the correct structure, skipping.`);
                } else {
                  warnings.push(`Item at index ${index} does not follow the correct structure, skipping.`);
                }
                return false;
            } else if (item.hasOwnProperty("ignore") && typeof item.ignore === 'boolean' && item.ignore) {
              return false;
            } else {
              let replacedExpression = item.expression.replace(/(compartment|parameter|reactant1|reactant2|reactant3|product1|product2|product3|enzyme|\*\*|\^)/g, function(match) {
                if (match === "**") {
                    return "^";
                } else {
                    return "1";
                }
              });
              try {
                console.log(replacedExpression)
                // Test expression validity
                math.evaluate(replacedExpression);
                return true;
              } catch (error) {
                warnings.push(`Rate law [${item.name}] has an invalid expression: ${error}`);
                return false;
              }
            }
          });
          if (warnings.length > 0) {
            let warningMessage = "";
            warningMessage += 'Some items in your JSON file were invalid and have been removed.\n';
            warningMessage += 'Details:\n';
            warnings.forEach(warning => warningMessage += warning + "\n");
            alert(warningMessage);
          }
          console.log(jsonData); // Logs the JSON data to the console
        } catch (error) {
          alert('Error parsing JSON file:', error);
        }
      },
      false
    );
    if (file) {
      jsonFileReader.readAsText(file);
    }
  }
  



    function adjustFontSize(value) {
      document.getElementById('sbml_output').style.fontSize = value + "rem";
    }

    function adjustInputFontSize(value) {
      document.getElementById('bioModelInput').style.fontSize = value + "rem";
    }

    function loadFile() {
      clearPreviousLoads();
      var input = document.getElementById('sbml_file');
      if(input.files.length > 0) {
          var fileName = input.files[0].name;
          document.getElementById('drop-zone').innerText = 'File chosen: ' + fileName;
      } else {
          document.getElementById('drop-zone').innerText = 'Drop file or choose file (.xml, .ant, .txt)';
      }
      const fileInput = document.querySelector("input[type=file]");
      const [file] = fileInput.files;
      const fileReader = new FileReader();

      fileReader.addEventListener(
        "load",
        () => {
          const modelStr = fileReader.result;
          if (modelStr.includes("<sbml")) {
            var ptrSBMLCode = jsAllocateUTF8(modelStr);
            var loadInt = loadSBMLString(ptrSBMLCode);
            if (loadInt > 0) {
              document.getElementById("bioModelInput").innerText = getAntimonyString();
              changeSBML(document.getElementById("bioModelInput").innerText, pyodide);
            } else {
              const outputBox = document.getElementById("sbml_output");
              outputBox.innerHTML = "";

              const errorMessage = document.createElement("div");
              errorMessage.className = "error-message";
              errorMessage.textContent = getLastError();

              outputBox.appendChild(errorMessage);
            }
            jsFree(ptrSBMLCode);
          } else {
            document.getElementById("bioModelInput").innerText = modelStr;
            var ptrAntCode = jsAllocateUTF8(modelStr);
            var loadInt = loadAntimonyString(ptrAntCode);
            if (loadInt > 0) {
              changeSBML(getSBMLString(), pyodide);
            } else {
              const outputBox = document.getElementById("sbml_output");
              outputBox.innerHTML = "";

              const errorMessage = document.createElement("div");
              errorMessage.className = "error-message";
              errorMessage.textContent = getLastError();

              outputBox.appendChild(errorMessage);
            }
            jsFree(ptrAntCode);
          }
        },
        false
      );
      if (file) {
        fileReader.readAsText(file);
      }
    }

    function toggleNightMode() {
      const nightModeToggle = document.getElementById("night-mode-toggle");
      const body = document.body;
      body.classList.toggle("night-mode");
      if (body.classList.contains("night-mode")) {
        nightModeToggle.innerText = "Light Mode";
      } else {
        nightModeToggle.innerText = "Night Mode";
      }
    }

    function processFileInput() {
      clearPreviousLoads();
      const fileInput = document.querySelector("input[type=file]");
      if (fileInput.files.length === 0) {
        alert("Please select a file");
        return;
      }
      setLoading(true);

      const [file] = fileInput.files;
      const fileReader = new FileReader();

      fileReader.addEventListener(
        "load",
        () => {
          const modelStr = fileReader.result;
          changeSBML(modelStr, pyodide);
          setLoading(false);
        },
        false
      );

      if (file) {
        fileReader.readAsText(file);
      }
    }

    function processTextInput() {
      clearPreviousLoads();
      const modelStr = document.getElementById("bioModelInput").innerText;
      setLoading(true);
      changeSBML(modelStr, pyodide);
      setLoading(false);
    }

    /**
     * Converts a model string to SBML format and outputs information about the model. 
     *
     * @param {string} modelStr - The model string to be processed, in Antimony or SBML format.
     * @param {object} pyodide - A Pyodide object used to create the ProcessSBML object.
     */
    function changeSBML(modelStr, pyodide) {
      const outputBox = document.getElementById("sbml_output");
      outputBox.innerHTML = "";

      // Declare variables
      var sbmlResult;
      var SBMLProcessor;

      // Check if the model string contains the <sbml tag
      if (!modelStr.includes("<sbml")) {
        // If not, load the model string into Antimony
        var ptrAntCode = jsAllocateUTF8(modelStr)
        var loadInt = loadAntimonyString(ptrAntCode);
        console.log("processAntimony: int returned: ", loadInt);

        // If the model loaded successfully, get the SBML string
        if (loadInt > 0) {
          sbmlResult = getSBMLString();
        } else {
          outputBox.innerHTML = "";

          const errorMessage = document.createElement("div");
          errorMessage.className = "error-message";
          errorMessage.textContent = getLastError();

          outputBox.appendChild(errorMessage);
          jsFree(ptrAntCode);
          setLoading(false);
          return;
        }
        jsFree(ptrAntCode);

      } else {
        // If the model string already contains the <sbml tag, use it as is
        sbmlResult = modelStr;
      }

      // Try to create a new ProcessSBML object with the SBML string
      try {
        var checks = {};
        checks["reversibilityCheck"] = document.getElementById("reversibilityCheck").checked;
        checks["namingConvention"] = document.getElementById("namingConvention").checked;
        checks["formattingConvention"] = document.getElementById("formattingConvention").checked;
        


        SBMLProcessor = new ProcessSBML(sbmlResult, pyodide, lib, checks, jsonData);

        // If successful, get the species, parameters, and reactions from the ProcessSBML object
        const species = SBMLProcessor.getSpeciesList();
        const parameters = SBMLProcessor.getParameterList();
        const reactions = SBMLProcessor.reactions;

        // Create a string to display the results
        var ret = "";
        ret += `species: ${species.toString()}\n`;
        ret += `parameters: ${parameters.toString()}\n`;

        // Loop through the reactions and add them to the string
        for (var i = 0; i < reactions.length; i++) {
          if (reactions[i].id) {
            ret += `${reactions[i].id}: ${reactions[i].toString()}\n`;
          } else {
            ret += `reaction${i}: ${reactions[i].toString()}\n`;
          }
        }

        // Display the string in the HTML element with ID "sbml_output"
        const outputBox = document.getElementById("sbml_output");
        outputBox.innerHTML = "";

        // Split the ret string into lines
        const lines = ret.split("\n");

        // Iterate through the lines and create div elements for each line
        var errorWarningCount = 0;
        lines.forEach((line) => {
          if (line.trim() === "") return;

          const messageDiv = document.createElement("div");

          if (line.startsWith("Warning")) {
            messageDiv.className = "warning-message";
            errorWarningCount++;
          } else if (line.startsWith("Error")) {
            messageDiv.className = "error-message";
            errorWarningCount++;
          }

          messageDiv.textContent = line;
          outputBox.appendChild(messageDiv);
        });
        
        if (errorWarningCount === 0) {
          const noErrorDiv = document.createElement("div");
          noErrorDiv.className = "no-error-warning-message";
          noErrorDiv.textContent = "No Error Or Warning Found!";
          outputBox.prepend(noErrorDiv);
        }

      } catch(err) {
        const outputBox = document.getElementById("sbml_output");
        outputBox.innerHTML = "";

        const errorMessage = document.createElement("div");
        errorMessage.className = "error-message";
        errorMessage.textContent = err.stack;

        outputBox.appendChild(errorMessage);
      } finally {
        setLoading(false);
      }
    }

    async function copyInputToClipboard() {
      const inputElement = document.getElementById("bioModelInput");
      const tooltip = document.getElementById("copy-input-tooltip");
      try {
        await navigator.clipboard.writeText(inputElement.innerText);
        // Show the tooltip
        tooltip.style.visibility = "visible";
        tooltip.style.opacity = "1";

        // After 3 seconds, hide the tooltip
        setTimeout(() => {
          tooltip.style.visibility = "hidden";
          tooltip.style.opacity = "0";
        }, 3000);
      } catch (err) {
        console.error("Error copying text: ", err);
        alert("Error copying output to clipboard. Please try again.");
      }
    }

    async function copyToClipboard() {
      const outputElement = document.getElementById("sbml_output");
      const tooltip = document.getElementById("copy-tooltip");
      try {
        await navigator.clipboard.writeText(outputElement.innerText);
        // alert("Output copied to clipboard!");
        // Show the tooltip
        tooltip.style.visibility = "visible";
        tooltip.style.opacity = "1";

        // After 3 seconds, hide the tooltip
        setTimeout(() => {
          tooltip.style.visibility = "hidden";
          tooltip.style.opacity = "0";
        }, 3000);
      } catch (err) {
        console.error("Error copying text: ", err);
        alert("Error copying output to clipboard. Please try again.");
      }
    }

    $(function () {
      $('[data-bs-toggle="tooltip"]').tooltip();
      $('#basic-error-check').click(function() {
        if ($('#basic-error-check-icon').hasClass('fa-chevron-right')) {
          $('#basic-error-check-icon').removeClass('fa-chevron-right').addClass('fa-chevron-down');
        } else {
          $('#basic-error-check-icon').removeClass('fa-chevron-down').addClass('fa-chevron-right');
        }
        $('#basic-error-check-list').toggle();
      });
    })
  </script>
</head>

<body>
  <div id="loadingOverlay" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.8); z-index: 9999; cursor: progress;">
    <div id="loadingStatus" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-size: 20px;">
        Loading...
    </div>
  </div>
  <div class="container py-5">
    <div class="d-flex justify-content-center align-items-center mb-4">
      <h1 class="mb-0">RateSB</h1>
      <button id="night-mode-toggle" class="night-mode-switch ms-3" onclick="toggleNightMode()">
        Night Mode
      </button>
    </div>
    <p class="text-center">Accepts SBML and Antimony files, or paste Antimony model in the text box.
      <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#infoModal">Info</button>
      <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#errorCodesModal">View Error Codes</button>
    </p>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="infoModalLabel">Website Info</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>If a file is given, the Antimony version (if the given input is in SBML, it will be converted into Antimony) will be available in the text input box on the left.</p>
            <p>"Analyze File" button analyzes the file directly.</p>
            <p>"Analyze Model" button analyzes the Antimony text in the text box.</p>
            <p>When double clicking on a word in the left text box, find all instances of that word in the right-side output box and highlight them. You can then use the Tab key to navigate through each highlighted instance.</p>
            <p>Currently, annotation check only works after the first load.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="errorCodesModal" tabindex="-1" aria-labelledby="errorCodesModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="errorCodesModalLabel">Error and Warning Codes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Error code explanations -->
            <h5 style="background-color:#ff4d4d;">Error Codes:</h5>
            <p><strong>E001:</strong> No Rate Law entered<br> - The rate law is missing for the given reaction. Please provide a rate law to proceed.</p>
            <p><strong>E002:</strong> Expecting reactant in rate law but not found<br> - The reaction contains floating reactants, which are not part of any rate law expression. Please ensure all reactants are included in the rate law expression.</p>
        
            <!-- Warning code explanations -->
            <h5 style="background-color:#ffcc00;">Warning Codes:</h5>
            <p><strong>W001:</strong> Rate law contains only number<br> - The rate law consists of only a numeric value. This is usually not a valid rate law for a reaction.</p>
            <p><strong>W002:</strong> Unrecognized rate law from the standard list (and the custom list if given)<br> - The rate law provided does not match any of the recognized standard and custom rate laws. Please verify the rate law and make sure it is in a supported format.</p>
            <p><strong>W003:</strong> Flux is not increasing as reactant increases<br> - The rate law contains reactant that has a non-positive relationship with the reaction flux. Note: some parameters might not be initialized or assigned a wrong value.</p>
            <p><strong>W004:</strong> Flux is not decreasing as product increases<br> - The rate law contains product that has a non-negative relationship with the reaction flux. Note: some parameters might not be initialized or assigned a wrong value.</p>
            <p><strong>W005:</strong> Expecting boundary species reactant in rate law but not found<br> - The reaction contains boundary species reactants that are not part of any rate law expression. Please ensure all reactants are included in the rate law expression.</p>
            <p><strong>W006:</strong> Expecting parameters to be constants<br> - The parameters in a rate law should be declared as constants in SBML.</p>
            <h5>Reversibility:</h5>
            <p><strong>W010:</strong> Irreversible reaction kinetic law contains products<br> - The rate law for an irreversible reaction should not include products. Please verify the rate law and adjust accordingly.</p>
            <h5>Naming Conventions:</h5>
            <p><strong>W020:</strong> We recommend that these parameters start with 'k'<br> - Certain parameters in the rate law are not following the recommended naming convention (starting with 'k'). Consider renaming these parameters to improve readability.</p>
            <p><strong>W021:</strong> We recommend that these parameters start with 'K'<br> - Certain parameters in the rate law are not following the recommended naming convention (starting with 'K'). Consider renaming these parameters to improve readability.</p>
            <p><strong>W022:</strong> We recommend that these parameters start with 'V'<br> - Certain parameters in the rate law are not following the recommended naming convention (starting with 'V'). Consider renaming these parameters to improve readability.</p>
            <h5>Formatting Conventions:</h5>
            <p><strong>W030:</strong> Elements of the same type are not ordered properly<br> - Compartments and parameters are not in alphabetical order, or species are of different order as they appear in the reaction. Reordering the elements can improve readability and consistency.</p>
            <p><strong>W031:</strong> Formatting convention not followed (compartment before parameters before species)<br> - The rate law does not follow the recommended formatting convention, which suggests placing compartments before parameters and species. Adjust the rate law to adhere to this convention for better readability and consistency.</p>
            <p><strong>W032:</strong> Denominator not in alphabetical order<br> - The denominator in the rate law is not ordered alphabetically. Reordering the elements can improve readability and consistency.</p>
            <p><strong>W033:</strong> Numerator and denominator not in alphabetical order<br> - Both the numerator and denominator in the rate law are not ordered alphabetically. Reordering the elements can improve readability and consistency.</p>
            <p><strong>W034:</strong> Numerator convention not followed and denominator not in alphabetical order<br> - The numerator in the rate law does not follow the recommended formatting convention and the denominator is not ordered alphabetically. Adjust the rate law to adhere to these conventions for better readability and consistency.</p>
            <p><strong>W035:</strong> Denominator convention not followed<br> - The denominator in the rate law does not follow the recommended formatting convention. Adjust the rate law to adhere to this convention for better readability and consistency.</p>
            <p><strong>W036:</strong> Numerator not in alphabetical order and denominator convention not followed<br> - The numerator in the rate law is not ordered alphabetically and the denominator does not follow the recommended formatting convention. Adjust the rate law to adhere to these conventions for better readability and consistency.</p>
            <p><strong>W037:</strong> Numerator and denominator convention not followed<br> - Both the numerator and denominator in the rate law do not follow the recommended formatting convention. Adjust the rate law to adhere to this convention for better readability and consistency.</p>
            <h5>SBOTerm Annotations:</h5>
            <p><strong>W040:</strong> Uni-directional mass action annotation not following recommended SBO terms<br> - We recommend annotations to be subclasses of: SBO_0000430, SBO_0000041.</p>
            <p><strong>W041:</strong> Uni-term with the moderator annotation not following recommended SBO terms<br> - We recommend annotations to be subclasses of: SBO_0000041.</p>
            <p><strong>W042:</strong> Bi-directional mass action or Bi-terms with the moderator annotation not following recommended SBO terms<br> - We recommend annotations to be subclasses of: SBO_0000042.</p>
            <p><strong>W043:</strong> Michaelis-Menten kinetics without an explicit enzyme annotation not following recommended SBO terms<br> - We recommend annotations to be subclasses of: SBO_0000028.</p>
            <p><strong>W044:</strong> Michaelis-Menten kinetics with an explicit enzyme annotation not following recommended SBO terms<br> - We recommend annotations to be subclasses of: SBO_0000028, SBO_0000430.</p>
        </div>
        
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="customClassificationModal" tabindex="-1" aria-labelledby="customClassificationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="customClassificationModalLabel">Custom Classification File Manual</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h2>Create Your Own Custom Rate Law</h2>
            <p>The custom rate law file allows you to check if the rate laws in your model are following the custom rate laws form or the standard rate law form, and will warn if not.</p>
            <p>Below is a guide on how to create and structure your own custom rate law:</p>

            <h3>1. Define the Rate Law's Name</h3>
            <p>Provide a unique and descriptive name for your custom rate law.</p>
            <pre><code>{
    "name": "Michaelis-Menten"
}
            </code></pre>

            <h3>2. Define the Expression</h3>
            <p>Describe the mathematical formula representing your rate law. Ensure you use the symbols provided:</p>
            <ul>
                <li>compartment</li>
                <li>parameter</li>
                <li>reactant1, reactant2, reactant3</li>
                <li>product1, product2, product3</li>
                <li>enzyme</li>
            </ul>
            <p>Note: Do NOT use the term "species" in your expression.</p>
            <pre><code>{
    "expression": "compartment * parameter * reactant1 / (reactant1 + parameter)"
}
            </code></pre>

            <h3>3. Define Optional Symbols</h3>
            <p>These are symbols that don't have to be included in the rate law. List them in the format shown below:</p>
            <pre><code>{
    "optional_symbols": ["compartment"]
}
            </code></pre>
            <p>In this case a rate law following the expression with or without compartment will be classified as Michaelis-Menten.</p>

            <h3>4. Power Limited Species</h3>
            <p>Specify which species have a power that needs to be considered. If the power of a certain species matters for the rate law, mention it in the expression. Add them to the list as shown:</p>
            <pre><code>{
    "power_limited_species": ["reactant1"]
}
            </code></pre>
            <p>In this case the power of reactant1 has to be 1, while other symbols can have any positive integer power. There can be multiple parameter, for example <pre><code>k1 * k2 * S1 / (S1 + k3)</code></pre> where k1, k2, k3 are parameters and S1 is the reactant is classified as Michaelis-Menten according to the expression above.</p>

            <h3>Final Structure</h3>
            <p>Your custom rate law should look like this:</p>
            <pre><code>{
    "name": "Michaelis-Menten",
    "expression": "compartment * parameter * reactant1 / (reactant1 + parameter)",
    "optional_symbols": ["compartment"],
    "power_limited_species": ["reactant1"]
}
            </code></pre>

            <p>Once you've created your custom rate law, you can use it in ratesb by uploading it to the custom classification file section.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="mb-3" style="width: 100%;">
          <input type="file" accept=".xml,.ant,.txt" id="sbml_file" name="SBML file" class="form-control" onchange="loadFile()" style="display: none;">
          <label for="sbml_file" style="width: 100%;">
              <div id="drop-zone" ondragover="handleDragOver(event)" ondrop="handleFileDrop(event)" style="border: 2px dashed #999; padding: 20px; text-align: center; cursor: pointer; width: 100%; overflow: auto;">
                  Drop file or choose file (.xml, .ant, .txt)
              </div>
          </label>
        </div>
        <div class="mb-3">
          <button id="ClickMe" class="btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="right" onclick="processFileInput()" title="Click to analyze the file">Analyze File</button>
        </div>
      
        <div class="mb-3">
          <div id="bioModelInput" class="form-control" contenteditable="true" style="min-height:150px; overflow:auto; white-space: pre-wrap;"></div>
        </div>

        <div style="display: flex; align-items: center; margin-top: -15px; margin-bottom: 10px;">
          <label for="font-size-range" style="margin-right: 10px;">Font:</label>
          <input type="range" id="font-size-range" min="0.5" max="3" step="0.1" value="1" oninput="adjustInputFontSize(value)" style="width: 100%;">
        </div>

        <div class="mb-3">
          <button id="ClickMe" class="btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="right" onclick="processTextInput()" title="Click to analyze the model in the text box">Analyze Model</button>
          <button id="copyInputToClipboard" class="btn btn-secondary" onclick="copyInputToClipboard()">Copy to Clipboard</button>
          <span id="copy-input-tooltip" style="visibility: hidden; opacity: 0; transition: visibility 0s, opacity 0.5s linear;">Copied to clipboard!</span>
        </div>
      

        <div id="basic-error-check-container">
          <div id="basic-error-check" class="basic-error-check" style="cursor: pointer;">
            <i id="basic-error-check-icon" class="fas fa-chevron-right"></i>
            <span>&nbsp;Basic Error Checks</span>
          </div>
          <div id="basic-error-check-list" style="display: none; margin-left: 2em;">
            <div class="basic-error-check-item">
              <input type="checkbox" checked disabled>
              <span class="info-tooltip" data-bs-toggle="tooltip" data-bs-placement="right" title="Checks if rate laws commonly used are entered">Common Rate Law Check</span>
            </div>
            <div class="basic-error-check-item">
              <input type="checkbox" checked disabled>
              <span class="info-tooltip" data-bs-toggle="tooltip" data-bs-placement="right" title="Checks if any parameter values are non constants">Constant Parameter Check</span>
            </div>
            <div class="basic-error-check-item">
              <input type="checkbox" checked disabled>
              <span class="info-tooltip" data-bs-toggle="tooltip" data-bs-placement="right" title="Checks if any rate law is missing a reactant">Floating Species Check</span>
            </div>
            <div class="basic-error-check-item">
              <input type="checkbox" checked disabled>
              <span class="info-tooltip" data-bs-toggle="tooltip" data-bs-placement="right" title="Checks if the rate is positive">Positive Flux Check</span>
            </div>
            <div class="basic-error-check-item">
              <input type="checkbox" checked disabled>
              <span class="info-tooltip" data-bs-toggle="tooltip" data-bs-placement="right" title="Checks if the annotations within the model are consistent with the rate law entered">Annotation Check</span>
            </div>
          </div>
        </div>

        <div id="custom-rate-law-container">
          <div id="custom-rate-law" class="basic-error-check" style="cursor: pointer;" onclick="toggleDropdown('custom-rate-law-list')">
            <i id="custom-rate-law-icon" class="fas fa-chevron-right"></i>
            <span>&nbsp;Custom Rate Law Classification</span>
          </div>
          <div id="custom-rate-law-list" style="display: none; margin-left: 2em;">
              <div class="custom-rate-law-item" style="display: flex; align-items: center;">
                  <input type="file" id="json_file" accept=".json" onchange="loadJsonFile()" style="display: none;">
                  <button onclick="document.getElementById('json_file').click();" ondragover="handleJsonDragOver(event)" ondrop="handleJsonFileDrop(event)" style="margin-right: 10px;">Choose File</button>
                  <span id="uploadedFileName" style="flex-grow: 1; margin-right: 10px;"></span>
                  <button onclick="downloadJson()" style="margin-right: 10px;" title="Download default json for rate laws">Download Sample</button>
                  <button data-bs-toggle="modal" data-bs-target="#customClassificationModal" style="margin-right: 10px;">Info</button>
              </div>
          </div>
      </div>
      
      <!-- Modal for Info Button -->
      <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
              <div class="modal-content">
                  <div class="modal-header">
                      <h2 class="modal-title" id="infoModalLabel">Create Your Own Custom Rate Law</h2>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <!-- Add the content of the info button here -->
                      <!-- ... -->
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
              </div>
          </div>
      </div>

        <div class="basic-error-check-item">
          <div style="flex: 1;">
            <input type="checkbox" id="reversibilityCheck" name="reversibilityCheck">
            <label for="reversibilityCheck" data-bs-toggle="tooltip" data-bs-placement="right" title="Warns when irreversible reaction rate law includes any product">Reversibility Check</label>
          </div>
        </div>
        
        <div class="basic-error-check-item">
          <div style="flex: 1;">
            <input type="checkbox" id="namingConvention" name="namingConvention">
            <label for="namingConvention" data-bs-toggle="tooltip" data-bs-placement="right" title="Warns when a symbol name is not common">Naming Convention Check</label>
          </div>
        </div>
        
        <div class="basic-error-check-item">
          <div style="flex: 1;">
            <input type="checkbox" id="formattingConvention" name="formattingConvention">
            <label for="formattingConvention" data-bs-toggle="tooltip" data-bs-placement="right" title="Warns when symbols are not ordered conventionally">Formatting Convention Check</label>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <h5>Rate Law Analysis:</h5>
        <div class="spinner-border text-primary" role="status" id="loading-icon" style="display: none;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="output-container">
          <div id="sbml_output" class="output-box" style="font-size: 1rem;"></div>
        </div>
        <span id="copy-tooltip" style="visibility: hidden; opacity: 0; transition: visibility 0s, opacity 0.5s linear;">Copied to clipboard!</span>
        <div style="display: flex; align-items: center; margin-top: -20px;">
          <label for="font-size-range" style="margin-right: 10px;">Font:</label>
          <input type="range" id="font-size-range" min="0.5" max="3" step="0.1" value="1" oninput="adjustFontSize(value)" style="width: 100%;">
        </div>    
        <button id="copyToClipboard" class="btn btn-secondary mt-3" onclick="copyToClipboard()">Copy to Clipboard</button>    
      </div>
    </div>
  </div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js" integrity="sha384-5n0eY3kH6cg3xgF5Z6AAoM6x0jzA6n9+3GdH/7u6g9FJs4Ck5BdPtF+to8xM6B5z" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
  })
  function displayFileName() {
    let inputElem = document.getElementById('json_file');
    if(inputElem.value) {
        document.getElementById('uploadedFileName').textContent = inputElem.files[0].name;
    }
  }

  function toggleDropdown(id) {
    const dropdownContent = document.getElementById(id);
    if (dropdownContent.style.display === 'none' || dropdownContent.style.display === '') {
        dropdownContent.style.display = 'block';
    } else {
        dropdownContent.style.display = 'none';
    }
}
</script>
</body>
</html>